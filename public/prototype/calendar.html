<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>window.FontAwesomeConfig = { autoReplaceSvg: 'nest' };</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        ::-webkit-scrollbar { display: none; }
        * { font-family: 'Inter', sans-serif; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#64748b'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50">
    <div class="flex h-screen">
        <aside id="sidebar" class="w-64 bg-white shadow-lg border-r border-gray-200 flex-shrink-0 transition-all duration-300">
            <div class="p-4 border-b border-gray-200">
                <div class="logo-container flex items-center space-x-3">
                    <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-home text-white text-lg"></i>
                    </div>
                    <div class="logo-text">
                        <h1 class="text-xl font-bold text-gray-900 whitespace-nowrap">RealEstate AI</h1>
                        <p class="text-sm text-gray-500 whitespace-nowrap">Agent Assistant</p>
                    </div>
                </div>
            </div>

            <nav class="mt-6 px-2">
                <ul class="space-y-2">
                    <li><a href="/prototype/dashboard" target="_top" class="flex items-center px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg"><i class="fas fa-chart-line w-5 mr-3 flex-shrink-0"></i><span class="nav-text whitespace-nowrap">Dashboard</span></a></li>
                    <li><a href="/prototype/leads" target="_top" class="flex items-center px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg"><i class="fas fa-users w-5 mr-3 flex-shrink-0"></i><span class="nav-text whitespace-nowrap">Leads</span></a></li>
                    <li><a href="/prototype/campaigns" target="_top" class="flex items-center px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg"><i class="fas fa-bullhorn w-5 mr-3 flex-shrink-0"></i><span class="nav-text whitespace-nowrap">Campaigns</span></a></li>
                    <li><a href="/prototype/follow-ups" target="_top" class="flex items-center px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg"><i class="fas fa-clock w-5 mr-3 flex-shrink-0"></i><span class="nav-text whitespace-nowrap">Follow-Ups</span></a></li>
                    <li><a href="/prototype/conversations" target="_top" class="flex items-center px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg"><i class="fas fa-comments w-5 mr-3 flex-shrink-0"></i><span class="nav-text whitespace-nowrap">Conversations</span></a></li>
                    <li><a href="/prototype/calendar" target="_top" class="flex items-center px-4 py-3 text-primary bg-blue-50 rounded-lg"><i class="fas fa-calendar w-5 mr-3 flex-shrink-0"></i><span class="nav-text whitespace-nowrap">Calendar</span></a></li>
                    <li><a href="/prototype/logs" target="_top" class="flex items-center px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg"><i class="fas fa-file-alt w-5 mr-3 flex-shrink-0"></i><span class="nav-text whitespace-nowrap">Logs</span></a></li>
                    <li><a href="/prototype/settings" target="_top" class="flex items-center px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg"><i class="fas fa-cog w-5 mr-3 flex-shrink-0"></i><span class="nav-text whitespace-nowrap">Settings</span></a></li>
                </ul>
            </nav>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header id="header" class="bg-white border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Calendar & Appointments</h2>
                        <p class="text-gray-500">View scheduled meetings and follow-ups</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button id="create-invite-btn" class="bg-primary hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2">
                            <i class="fas fa-plus"></i>
                            <span>Create Invite</span>
                        </button>
                        <div class="flex items-center space-x-3">
                            <img src="https://storage.googleapis.com/uxpilot-auth.appspot.com/avatars/avatar-2.jpg" alt="Profile" class="profile-avatar w-10 h-10 rounded-full">
                            <div>
                                <p class="text-sm font-medium text-gray-900 profile-name">Loading...</p>
                                <p class="text-xs text-gray-500 profile-company">Real Estate Agent</p>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Calendar Grid -->
                    <section id="calendar-view" class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center space-x-4">
                                <button id="prev-month" class="p-2 hover:bg-gray-100 rounded-lg">
                                    <i class="fas fa-chevron-left text-gray-600"></i>
                                </button>
                                <h3 id="current-month" class="text-xl font-semibold text-gray-900">February 2026</h3>
                                <button id="next-month" class="p-2 hover:bg-gray-100 rounded-lg">
                                    <i class="fas fa-chevron-right text-gray-600"></i>
                                </button>
                            </div>
                            <button id="today-btn" class="px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg">Today</button>
                        </div>

                        <div class="grid grid-cols-7 gap-px bg-gray-200 border border-gray-200 rounded-lg overflow-hidden">
                            <div class="bg-gray-50 p-3 text-center"><span class="text-xs font-semibold text-gray-600">Sun</span></div>
                            <div class="bg-gray-50 p-3 text-center"><span class="text-xs font-semibold text-gray-600">Mon</span></div>
                            <div class="bg-gray-50 p-3 text-center"><span class="text-xs font-semibold text-gray-600">Tue</span></div>
                            <div class="bg-gray-50 p-3 text-center"><span class="text-xs font-semibold text-gray-600">Wed</span></div>
                            <div class="bg-gray-50 p-3 text-center"><span class="text-xs font-semibold text-gray-600">Thu</span></div>
                            <div class="bg-gray-50 p-3 text-center"><span class="text-xs font-semibold text-gray-600">Fri</span></div>
                            <div class="bg-gray-50 p-3 text-center"><span class="text-xs font-semibold text-gray-600">Sat</span></div>
                        </div>
                        <div id="calendar-grid" class="grid grid-cols-7 gap-px bg-gray-200 border-x border-b border-gray-200 rounded-b-lg overflow-hidden">
                            <!-- Days will be rendered here -->
                        </div>
                    </section>

                    <!-- Upcoming Events -->
                    <section id="upcoming-events" class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Upcoming Events</h3>
                        <div id="events-list" class="space-y-3">
                            <p class="text-gray-500 text-sm">Loading events...</p>
                        </div>
                    </section>
                </div>

                <!-- Stats -->
                <section id="meeting-stats" class="grid grid-cols-1 md:grid-cols-4 gap-6 mt-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">Total Meetings</p>
                                <p id="stat-meetings" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-calendar-check text-blue-600"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">Follow-ups Due</p>
                                <p id="stat-followups" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                            <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-clock text-yellow-600"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">This Week</p>
                                <p id="stat-week" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-calendar-week text-green-600"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">Today</p>
                                <p id="stat-today" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-calendar-day text-purple-600"></i>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Create Invite Modal -->
    <div id="invite-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-900">Schedule Meeting</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="p-6 overflow-y-auto flex-1">
                <form id="invite-form" class="space-y-4">
                    <!-- Lead Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Lead</label>

                        <!-- Tabs -->
                        <div class="flex border-b border-gray-200 mb-3">
                            <button type="button" id="tab-manual" onclick="switchLeadTab('manual')" class="px-4 py-2 text-sm font-medium border-b-2 border-primary text-primary">
                                Enter Manually
                            </button>
                            <button type="button" id="tab-followups" onclick="switchLeadTab('followups')" class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                                From Follow-ups
                            </button>
                            <button type="button" id="tab-campaigns" onclick="switchLeadTab('campaigns')" class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                                From Campaigns
                            </button>
                        </div>

                        <!-- Manual Entry -->
                        <div id="panel-manual" class="">
                            <input id="invite-phone" type="tel" placeholder="+1234567890" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>

                        <!-- Follow-ups List -->
                        <div id="panel-followups" class="hidden">
                            <div id="followups-list" class="max-h-48 overflow-y-auto border border-gray-200 rounded-lg">
                                <p class="p-3 text-gray-500 text-sm">Loading follow-ups...</p>
                            </div>
                        </div>

                        <!-- Campaigns List -->
                        <div id="panel-campaigns" class="hidden">
                            <div id="campaigns-list" class="max-h-48 overflow-y-auto border border-gray-200 rounded-lg">
                                <p class="p-3 text-gray-500 text-sm">Loading campaign leads...</p>
                            </div>
                        </div>

                        <!-- Selected Lead Display -->
                        <div id="selected-lead" class="hidden mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-900" id="selected-lead-name">-</p>
                                    <p class="text-sm text-gray-600" id="selected-lead-phone">-</p>
                                </div>
                                <button type="button" onclick="clearSelectedLead()" class="text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                            <input id="invite-date" type="date" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Time</label>
                            <input id="invite-time" type="time" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Note (optional)</label>
                        <input id="invite-note" type="text" placeholder="e.g., Property viewing at Oak Street" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                    <div class="flex items-center justify-end gap-3 pt-4">
                        <button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
                        <button id="save-meeting-btn" type="button" class="px-5 py-2 bg-primary text-white rounded-lg hover:bg-blue-700">
                            Schedule & Add to Calendar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-900 text-white px-4 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <span id="toast-message"></span>
    </div>

    <script>
        let currentDate = new Date();
        let allEvents = [];
        let followUpLeads = [];
        let campaignLeads = [];
        let selectedLead = null;

        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

        // Lead Selection Functions
        function switchLeadTab(tab) {
            // Update tab styles
            ['manual', 'followups', 'campaigns'].forEach(t => {
                const tabBtn = document.getElementById(`tab-${t}`);
                const panel = document.getElementById(`panel-${t}`);
                if (t === tab) {
                    tabBtn.classList.add('border-primary', 'text-primary');
                    tabBtn.classList.remove('border-transparent', 'text-gray-500');
                    panel.classList.remove('hidden');
                } else {
                    tabBtn.classList.remove('border-primary', 'text-primary');
                    tabBtn.classList.add('border-transparent', 'text-gray-500');
                    panel.classList.add('hidden');
                }
            });

            // Load data if needed
            if (tab === 'followups' && followUpLeads.length === 0) {
                loadFollowUpLeads();
            } else if (tab === 'campaigns' && campaignLeads.length === 0) {
                loadCampaignLeads();
            }
        }

        async function loadFollowUpLeads() {
            const container = document.getElementById('followups-list');
            container.innerHTML = '<p class="p-3 text-gray-500 text-sm">Loading...</p>';

            try {
                const res = await fetch('/api/followups');
                const data = await res.json();

                if (data.ok && data.followups && data.followups.length > 0) {
                    followUpLeads = data.followups;
                    renderFollowUpsList();
                } else {
                    container.innerHTML = '<p class="p-3 text-gray-500 text-sm">No contacted leads found. Send campaigns first.</p>';
                }
            } catch (err) {
                container.innerHTML = '<p class="p-3 text-red-500 text-sm">Failed to load follow-ups.</p>';
            }
        }

        function renderFollowUpsList() {
            const container = document.getElementById('followups-list');
            if (followUpLeads.length === 0) {
                container.innerHTML = '<p class="p-3 text-gray-500 text-sm">No contacted leads found.</p>';
                return;
            }

            container.innerHTML = followUpLeads.map(fu => {
                const name = fu.ownerName || 'Unknown';
                const phone = fu.phone || '';
                const property = fu.propertyAddress || '';
                const days = fu.daysSinceContact || 0;
                const status = fu.responseStatus || 'no_response';
                const statusColor = status === 'replied' ? 'text-green-600' : status === 'no_response' ? 'text-yellow-600' : 'text-gray-600';
                const statusText = status === 'replied' ? 'Replied' : status === 'no_response' ? 'No response' : status;

                return `
                    <div class="p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-0" onclick="selectLead('${escapeHtml(name)}', '${escapeHtml(phone)}', '${escapeHtml(property)}')">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-medium text-gray-900">${escapeHtml(name)}</p>
                                <p class="text-sm text-gray-600">${escapeHtml(phone)}</p>
                                ${property ? `<p class="text-xs text-gray-500">${escapeHtml(property)}</p>` : ''}
                            </div>
                            <div class="text-right">
                                <p class="text-xs ${statusColor}">${statusText}</p>
                                <p class="text-xs text-gray-400">${days} days ago</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadCampaignLeads() {
            const container = document.getElementById('campaigns-list');
            container.innerHTML = '<p class="p-3 text-gray-500 text-sm">Loading...</p>';

            try {
                const res = await fetch('/api/campaigns/leads');
                const data = await res.json();

                if (data.ok && data.leads && data.leads.length > 0) {
                    campaignLeads = data.leads;
                    renderCampaignsList();
                } else {
                    container.innerHTML = '<p class="p-3 text-gray-500 text-sm">No campaign leads found. Generate messages first.</p>';
                }
            } catch (err) {
                container.innerHTML = '<p class="p-3 text-red-500 text-sm">Failed to load campaign leads.</p>';
            }
        }

        function renderCampaignsList() {
            const container = document.getElementById('campaigns-list');
            if (campaignLeads.length === 0) {
                container.innerHTML = '<p class="p-3 text-gray-500 text-sm">No campaign leads found.</p>';
                return;
            }

            container.innerHTML = campaignLeads.map(lead => {
                const name = lead.owner_name || 'Unknown';
                const phone = lead.phone || '';
                const property = lead.property_address || '';
                const score = lead.score_category || 'Warm';
                const scoreColor = score === 'Hot' ? 'text-red-600' : score === 'Warm' ? 'text-orange-600' : 'text-blue-600';

                return `
                    <div class="p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-0" onclick="selectLead('${escapeHtml(name)}', '${escapeHtml(phone)}', '${escapeHtml(property)}')">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-medium text-gray-900">${escapeHtml(name)}</p>
                                <p class="text-sm text-gray-600">${escapeHtml(phone)}</p>
                                ${property ? `<p class="text-xs text-gray-500">${escapeHtml(property)}</p>` : ''}
                            </div>
                            <div class="text-xs ${scoreColor}">${score}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectLead(name, phone, property) {
            selectedLead = { name, phone, property };

            // Update UI
            document.getElementById('selected-lead').classList.remove('hidden');
            document.getElementById('selected-lead-name').textContent = name;
            document.getElementById('selected-lead-phone').textContent = phone + (property ? ` - ${property}` : '');

            // Update the phone input
            document.getElementById('invite-phone').value = phone;

            // Pre-fill note with property if available
            if (property && !document.getElementById('invite-note').value) {
                document.getElementById('invite-note').value = `Meeting about ${property}`;
            }
        }

        function clearSelectedLead() {
            selectedLead = null;
            document.getElementById('selected-lead').classList.add('hidden');
            document.getElementById('invite-phone').value = '';
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Generate Google Calendar URL
        function getGoogleCalendarUrl(title, date, time, duration = 60, location = '', description = '') {
            const startDate = new Date(`${date}T${time}`);
            const endDate = new Date(startDate.getTime() + duration * 60000);

            const formatDate = (d) => d.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';

            const params = new URLSearchParams({
                action: 'TEMPLATE',
                text: title,
                dates: `${formatDate(startDate)}/${formatDate(endDate)}`,
                details: description,
                location: location
            });

            return `https://calendar.google.com/calendar/render?${params.toString()}`;
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById("toast");
            const toastMsg = document.getElementById("toast-message");
            toastMsg.textContent = message;
            toast.className = toast.className.replace("bg-gray-900", isError ? "bg-red-600" : "bg-green-600");
            toast.classList.remove("translate-y-20", "opacity-0");
            setTimeout(() => {
                toast.classList.add("translate-y-20", "opacity-0");
                toast.className = toast.className.replace(isError ? "bg-red-600" : "bg-green-600", "bg-gray-900");
            }, 3000);
        }

        function openModal() {
            const modal = document.getElementById("invite-modal");
            modal.classList.remove("hidden");

            // Reset form
            document.getElementById("invite-phone").value = "";
            document.getElementById("invite-note").value = "";
            clearSelectedLead();
            switchLeadTab('manual');

            // Set default date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById("invite-date").value = tomorrow.toISOString().split("T")[0];
            document.getElementById("invite-time").value = "14:00";
        }

        function closeModal() {
            document.getElementById("invite-modal").classList.add("hidden");
        }

        async function loadEvents() {
            try {
                const res = await fetch("/api/calendar/events");
                const data = await res.json();
                if (data.ok) {
                    allEvents = data.events || [];
                    renderCalendar();
                    renderUpcoming();
                    updateStats();
                }
            } catch (err) {
                console.error("Failed to load events:", err);
            }
        }

        function getEventsForDate(dateStr) {
            return allEvents.filter(e => e.date === dateStr);
        }

        function renderCalendar() {
            const grid = document.getElementById("calendar-grid");
            const monthLabel = document.getElementById("current-month");

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            monthLabel.textContent = `${months[month]} ${year}`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startPadding = firstDay.getDay();
            const totalDays = lastDay.getDate();

            const today = new Date();
            const todayStr = today.toISOString().split("T")[0];

            let html = "";

            // Previous month padding
            const prevMonth = new Date(year, month, 0);
            for (let i = startPadding - 1; i >= 0; i--) {
                const day = prevMonth.getDate() - i;
                html += `<div class="bg-gray-50 p-2 min-h-[80px]"><span class="text-sm text-gray-400">${day}</span></div>`;
            }

            // Current month days
            for (let day = 1; day <= totalDays; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = dateStr === todayStr;
                const events = getEventsForDate(dateStr);

                html += `<div class="bg-white p-2 min-h-[80px] hover:bg-gray-50 cursor-pointer" onclick="showDayEvents('${dateStr}')">`;
                html += `<span class="text-sm ${isToday ? 'bg-primary text-white rounded-full w-7 h-7 flex items-center justify-center' : 'text-gray-900'}">${day}</span>`;

                if (events.length > 0) {
                    html += `<div class="mt-1 space-y-1">`;
                    events.slice(0, 2).forEach(e => {
                        const color = e.type === 'meeting' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800';
                        const icon = e.type === 'meeting' ? 'fa-calendar-check' : 'fa-clock';
                        html += `<div class="text-xs ${color} px-1 py-0.5 rounded truncate"><i class="fas ${icon} mr-1"></i>${e.time || 'All day'}</div>`;
                    });
                    if (events.length > 2) {
                        html += `<div class="text-xs text-gray-500">+${events.length - 2} more</div>`;
                    }
                    html += `</div>`;
                }

                html += `</div>`;
            }

            // Next month padding
            const remaining = (7 - ((startPadding + totalDays) % 7)) % 7;
            for (let i = 1; i <= remaining; i++) {
                html += `<div class="bg-gray-50 p-2 min-h-[80px]"><span class="text-sm text-gray-400">${i}</span></div>`;
            }

            grid.innerHTML = html;
        }

        function renderUpcoming() {
            const list = document.getElementById("events-list");
            const today = new Date().toISOString().split("T")[0];

            const upcoming = allEvents.filter(e => e.date >= today).slice(0, 10);

            if (upcoming.length === 0) {
                list.innerHTML = `<p class="text-gray-500 text-sm">No upcoming events. Schedule meetings from Conversations or create one here.</p>`;
                return;
            }

            list.innerHTML = upcoming.map(e => {
                const color = e.type === 'meeting' ? 'bg-blue-500' : 'bg-yellow-500';
                const icon = e.type === 'meeting' ? 'fa-calendar-check' : 'fa-clock';
                const date = new Date(e.date);
                const dateDisplay = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                const title = `${e.type === 'meeting' ? 'Meeting' : 'Follow-up'} with ${e.phone}`;
                const calUrl = getGoogleCalendarUrl(title, e.date, e.time || '09:00', 60, '', e.note || '');

                return `
                    <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                        <div class="w-10 h-10 ${color} rounded-lg flex items-center justify-center flex-shrink-0">
                            <i class="fas ${icon} text-white"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900">${e.type === 'meeting' ? 'Meeting' : 'Follow-up'}</p>
                            <p class="text-xs text-gray-500">${e.phone}</p>
                            <p class="text-xs text-gray-600 mt-1">${dateDisplay}${e.time ? ' at ' + e.time : ''}</p>
                            ${e.note ? `<p class="text-xs text-gray-500 mt-1 truncate">${e.note}</p>` : ''}
                            <a href="${calUrl}" target="_blank" class="inline-flex items-center mt-2 text-xs text-primary hover:text-blue-700">
                                <i class="fab fa-google mr-1"></i> Add to Calendar
                            </a>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateStats() {
            const today = new Date();
            const todayStr = today.toISOString().split("T")[0];

            // Get start of week (Sunday)
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());
            const weekStartStr = weekStart.toISOString().split("T")[0];

            // Get end of week (Saturday)
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            const weekEndStr = weekEnd.toISOString().split("T")[0];

            const meetings = allEvents.filter(e => e.type === 'meeting');
            const followups = allEvents.filter(e => e.type === 'followup' && e.date >= todayStr);
            const thisWeek = allEvents.filter(e => e.date >= weekStartStr && e.date <= weekEndStr);
            const todayEvents = allEvents.filter(e => e.date === todayStr);

            document.getElementById("stat-meetings").textContent = meetings.length;
            document.getElementById("stat-followups").textContent = followups.length;
            document.getElementById("stat-week").textContent = thisWeek.length;
            document.getElementById("stat-today").textContent = todayEvents.length;
        }

        function showDayEvents(dateStr) {
            const events = getEventsForDate(dateStr);
            if (events.length === 0) {
                showToast(`No events on ${dateStr}`);
                return;
            }
            // Could open a modal here, for now just show toast
            showToast(`${events.length} event(s) on ${dateStr}`);
        }

        async function saveMeeting() {
            const phone = document.getElementById("invite-phone").value.trim();
            const date = document.getElementById("invite-date").value;
            const time = document.getElementById("invite-time").value;
            const note = document.getElementById("invite-note").value;

            if (!phone || !date || !time) {
                showToast("Phone, date, and time are required", true);
                return;
            }

            try {
                const res = await fetch("/api/leads/actions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        phone,
                        action: "schedule_meeting",
                        date,
                        time,
                        note
                    })
                });
                const data = await res.json();
                if (data.ok) {
                    showToast("Meeting scheduled!");
                    closeModal();
                    loadEvents();

                    // Open Google Calendar to add the event
                    const title = `Meeting with ${phone}`;
                    const calUrl = getGoogleCalendarUrl(title, date, time, 60, '', note);
                    window.open(calUrl, '_blank');
                } else {
                    showToast(data.error || "Failed to schedule", true);
                }
            } catch (err) {
                showToast("Failed to schedule meeting", true);
            }
        }

        // Event listeners
        document.getElementById("create-invite-btn").addEventListener("click", openModal);
        document.getElementById("close-modal-btn").addEventListener("click", closeModal);
        document.getElementById("save-meeting-btn").addEventListener("click", saveMeeting);

        document.getElementById("prev-month").addEventListener("click", () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });

        document.getElementById("next-month").addEventListener("click", () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });

        document.getElementById("today-btn").addEventListener("click", () => {
            currentDate = new Date();
            renderCalendar();
        });

        // Close modal on backdrop click
        document.getElementById("invite-modal").addEventListener("click", (e) => {
            if (e.target.id === "invite-modal") closeModal();
        });

        // Load on page load
        document.addEventListener("DOMContentLoaded", loadEvents);
    </script>
<script src="/prototype/js/profile-loader.js"></script>
<script src="/prototype/js/collapsible-sidebar.js"></script>
</body>
</html>
