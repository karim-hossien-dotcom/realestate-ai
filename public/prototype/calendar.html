<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>window.FontAwesomeConfig = { autoReplaceSvg: 'nest' };</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        ::-webkit-scrollbar { display: none; }
        * { font-family: 'Inter', sans-serif; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#64748b'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50">
    <div class="flex h-screen">
        <aside id="sidebar" class="w-64 bg-white shadow-lg border-r border-gray-200">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center">
                        <i class="fas fa-home text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">RealEstate AI</h1>
                        <p class="text-sm text-gray-500">Agent Assistant</p>
                    </div>
                </div>
            </div>

            <nav class="mt-6 px-4">
                <ul class="space-y-2">
                    <li><a href="/prototype/dashboard" target="_top" class="flex items-center px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg"><i class="fas fa-chart-line w-5 mr-3"></i>Dashboard</a></li>
                    <li><a href="/prototype/leads" target="_top" class="flex items-center px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg"><i class="fas fa-users w-5 mr-3"></i>Leads</a></li>
                    <li><a href="/prototype/campaigns" target="_top" class="flex items-center px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg"><i class="fas fa-bullhorn w-5 mr-3"></i>Campaigns</a></li>
                    <li><a href="/prototype/follow-ups" target="_top" class="flex items-center px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg"><i class="fas fa-clock w-5 mr-3"></i>Follow-Ups</a></li>
                    <li><a href="/prototype/conversations" target="_top" class="flex items-center px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg"><i class="fas fa-comments w-5 mr-3"></i>Conversations</a></li>
                    <li><a href="/prototype/calendar" target="_top" class="flex items-center px-4 py-3 text-primary bg-blue-50 rounded-lg"><i class="fas fa-calendar w-5 mr-3"></i>Calendar</a></li>
                    <li><a href="/prototype/logs" target="_top" class="flex items-center px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg"><i class="fas fa-file-alt w-5 mr-3"></i>Logs</a></li>
                    <li><a href="/prototype/settings" target="_top" class="flex items-center px-4 py-3 text-gray-700 hover:bg-gray-50 rounded-lg"><i class="fas fa-cog w-5 mr-3"></i>Settings</a></li>
                </ul>
            </nav>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header id="header" class="bg-white border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Calendar & Appointments</h2>
                        <p class="text-gray-500">View scheduled meetings and follow-ups</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button id="create-invite-btn" class="bg-primary hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2">
                            <i class="fas fa-plus"></i>
                            <span>Create Invite</span>
                        </button>
                        <div class="flex items-center space-x-3">
                            <img src="https://storage.googleapis.com/uxpilot-auth.appspot.com/avatars/avatar-2.jpg" alt="Profile" class="w-10 h-10 rounded-full">
                            <div>
                                <p class="text-sm font-medium text-gray-900">John Smith</p>
                                <p class="text-xs text-gray-500">Senior Agent</p>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Calendar Grid -->
                    <section id="calendar-view" class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center space-x-4">
                                <button id="prev-month" class="p-2 hover:bg-gray-100 rounded-lg">
                                    <i class="fas fa-chevron-left text-gray-600"></i>
                                </button>
                                <h3 id="current-month" class="text-xl font-semibold text-gray-900">February 2026</h3>
                                <button id="next-month" class="p-2 hover:bg-gray-100 rounded-lg">
                                    <i class="fas fa-chevron-right text-gray-600"></i>
                                </button>
                            </div>
                            <button id="today-btn" class="px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg">Today</button>
                        </div>

                        <div class="grid grid-cols-7 gap-px bg-gray-200 border border-gray-200 rounded-lg overflow-hidden">
                            <div class="bg-gray-50 p-3 text-center"><span class="text-xs font-semibold text-gray-600">Sun</span></div>
                            <div class="bg-gray-50 p-3 text-center"><span class="text-xs font-semibold text-gray-600">Mon</span></div>
                            <div class="bg-gray-50 p-3 text-center"><span class="text-xs font-semibold text-gray-600">Tue</span></div>
                            <div class="bg-gray-50 p-3 text-center"><span class="text-xs font-semibold text-gray-600">Wed</span></div>
                            <div class="bg-gray-50 p-3 text-center"><span class="text-xs font-semibold text-gray-600">Thu</span></div>
                            <div class="bg-gray-50 p-3 text-center"><span class="text-xs font-semibold text-gray-600">Fri</span></div>
                            <div class="bg-gray-50 p-3 text-center"><span class="text-xs font-semibold text-gray-600">Sat</span></div>
                        </div>
                        <div id="calendar-grid" class="grid grid-cols-7 gap-px bg-gray-200 border-x border-b border-gray-200 rounded-b-lg overflow-hidden">
                            <!-- Days will be rendered here -->
                        </div>
                    </section>

                    <!-- Upcoming Events -->
                    <section id="upcoming-events" class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Upcoming Events</h3>
                        <div id="events-list" class="space-y-3">
                            <p class="text-gray-500 text-sm">Loading events...</p>
                        </div>
                    </section>
                </div>

                <!-- Stats -->
                <section id="meeting-stats" class="grid grid-cols-1 md:grid-cols-4 gap-6 mt-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">Total Meetings</p>
                                <p id="stat-meetings" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-calendar-check text-blue-600"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">Follow-ups Due</p>
                                <p id="stat-followups" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                            <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-clock text-yellow-600"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">This Week</p>
                                <p id="stat-week" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-calendar-week text-green-600"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">Today</p>
                                <p id="stat-today" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-calendar-day text-purple-600"></i>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Create Invite Modal -->
    <div id="invite-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-900">Schedule Meeting</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="p-6">
                <form id="invite-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lead Phone</label>
                        <input id="invite-phone" type="tel" placeholder="+1234567890" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                            <input id="invite-date" type="date" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Time</label>
                            <input id="invite-time" type="time" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Note (optional)</label>
                        <input id="invite-note" type="text" placeholder="e.g., Property viewing at Oak Street" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                    <div class="flex items-center justify-end gap-3 pt-4">
                        <button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
                        <button id="save-meeting-btn" type="button" class="px-5 py-2 bg-primary text-white rounded-lg hover:bg-blue-700">
                            Schedule Meeting
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-900 text-white px-4 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <span id="toast-message"></span>
    </div>

    <script>
        let currentDate = new Date();
        let allEvents = [];

        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

        function showToast(message, isError = false) {
            const toast = document.getElementById("toast");
            const toastMsg = document.getElementById("toast-message");
            toastMsg.textContent = message;
            toast.className = toast.className.replace("bg-gray-900", isError ? "bg-red-600" : "bg-green-600");
            toast.classList.remove("translate-y-20", "opacity-0");
            setTimeout(() => {
                toast.classList.add("translate-y-20", "opacity-0");
                toast.className = toast.className.replace(isError ? "bg-red-600" : "bg-green-600", "bg-gray-900");
            }, 3000);
        }

        function openModal() {
            const modal = document.getElementById("invite-modal");
            modal.classList.remove("hidden");
            // Set default date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById("invite-date").value = tomorrow.toISOString().split("T")[0];
            document.getElementById("invite-time").value = "14:00";
        }

        function closeModal() {
            document.getElementById("invite-modal").classList.add("hidden");
        }

        async function loadEvents() {
            try {
                const res = await fetch("/api/calendar/events");
                const data = await res.json();
                if (data.ok) {
                    allEvents = data.events || [];
                    renderCalendar();
                    renderUpcoming();
                    updateStats();
                }
            } catch (err) {
                console.error("Failed to load events:", err);
            }
        }

        function getEventsForDate(dateStr) {
            return allEvents.filter(e => e.date === dateStr);
        }

        function renderCalendar() {
            const grid = document.getElementById("calendar-grid");
            const monthLabel = document.getElementById("current-month");

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            monthLabel.textContent = `${months[month]} ${year}`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startPadding = firstDay.getDay();
            const totalDays = lastDay.getDate();

            const today = new Date();
            const todayStr = today.toISOString().split("T")[0];

            let html = "";

            // Previous month padding
            const prevMonth = new Date(year, month, 0);
            for (let i = startPadding - 1; i >= 0; i--) {
                const day = prevMonth.getDate() - i;
                html += `<div class="bg-gray-50 p-2 min-h-[80px]"><span class="text-sm text-gray-400">${day}</span></div>`;
            }

            // Current month days
            for (let day = 1; day <= totalDays; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = dateStr === todayStr;
                const events = getEventsForDate(dateStr);

                html += `<div class="bg-white p-2 min-h-[80px] hover:bg-gray-50 cursor-pointer" onclick="showDayEvents('${dateStr}')">`;
                html += `<span class="text-sm ${isToday ? 'bg-primary text-white rounded-full w-7 h-7 flex items-center justify-center' : 'text-gray-900'}">${day}</span>`;

                if (events.length > 0) {
                    html += `<div class="mt-1 space-y-1">`;
                    events.slice(0, 2).forEach(e => {
                        const color = e.type === 'meeting' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800';
                        const icon = e.type === 'meeting' ? 'fa-calendar-check' : 'fa-clock';
                        html += `<div class="text-xs ${color} px-1 py-0.5 rounded truncate"><i class="fas ${icon} mr-1"></i>${e.time || 'All day'}</div>`;
                    });
                    if (events.length > 2) {
                        html += `<div class="text-xs text-gray-500">+${events.length - 2} more</div>`;
                    }
                    html += `</div>`;
                }

                html += `</div>`;
            }

            // Next month padding
            const remaining = (7 - ((startPadding + totalDays) % 7)) % 7;
            for (let i = 1; i <= remaining; i++) {
                html += `<div class="bg-gray-50 p-2 min-h-[80px]"><span class="text-sm text-gray-400">${i}</span></div>`;
            }

            grid.innerHTML = html;
        }

        function renderUpcoming() {
            const list = document.getElementById("events-list");
            const today = new Date().toISOString().split("T")[0];

            const upcoming = allEvents.filter(e => e.date >= today).slice(0, 10);

            if (upcoming.length === 0) {
                list.innerHTML = `<p class="text-gray-500 text-sm">No upcoming events. Schedule meetings from Conversations or create one here.</p>`;
                return;
            }

            list.innerHTML = upcoming.map(e => {
                const color = e.type === 'meeting' ? 'bg-blue-500' : 'bg-yellow-500';
                const icon = e.type === 'meeting' ? 'fa-calendar-check' : 'fa-clock';
                const date = new Date(e.date);
                const dateDisplay = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

                return `
                    <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                        <div class="w-10 h-10 ${color} rounded-lg flex items-center justify-center flex-shrink-0">
                            <i class="fas ${icon} text-white"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900">${e.type === 'meeting' ? 'Meeting' : 'Follow-up'}</p>
                            <p class="text-xs text-gray-500">${e.phone}</p>
                            <p class="text-xs text-gray-600 mt-1">${dateDisplay}${e.time ? ' at ' + e.time : ''}</p>
                            ${e.note ? `<p class="text-xs text-gray-500 mt-1 truncate">${e.note}</p>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateStats() {
            const today = new Date();
            const todayStr = today.toISOString().split("T")[0];

            // Get start of week (Sunday)
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());
            const weekStartStr = weekStart.toISOString().split("T")[0];

            // Get end of week (Saturday)
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            const weekEndStr = weekEnd.toISOString().split("T")[0];

            const meetings = allEvents.filter(e => e.type === 'meeting');
            const followups = allEvents.filter(e => e.type === 'followup' && e.date >= todayStr);
            const thisWeek = allEvents.filter(e => e.date >= weekStartStr && e.date <= weekEndStr);
            const todayEvents = allEvents.filter(e => e.date === todayStr);

            document.getElementById("stat-meetings").textContent = meetings.length;
            document.getElementById("stat-followups").textContent = followups.length;
            document.getElementById("stat-week").textContent = thisWeek.length;
            document.getElementById("stat-today").textContent = todayEvents.length;
        }

        function showDayEvents(dateStr) {
            const events = getEventsForDate(dateStr);
            if (events.length === 0) {
                showToast(`No events on ${dateStr}`);
                return;
            }
            // Could open a modal here, for now just show toast
            showToast(`${events.length} event(s) on ${dateStr}`);
        }

        async function saveMeeting() {
            const phone = document.getElementById("invite-phone").value.trim();
            const date = document.getElementById("invite-date").value;
            const time = document.getElementById("invite-time").value;
            const note = document.getElementById("invite-note").value;

            if (!phone || !date || !time) {
                showToast("Phone, date, and time are required", true);
                return;
            }

            try {
                const res = await fetch("/api/leads/actions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        phone,
                        action: "schedule_meeting",
                        date,
                        time,
                        note
                    })
                });
                const data = await res.json();
                if (data.ok) {
                    showToast("Meeting scheduled!");
                    closeModal();
                    loadEvents();
                } else {
                    showToast(data.error || "Failed to schedule", true);
                }
            } catch (err) {
                showToast("Failed to schedule meeting", true);
            }
        }

        // Event listeners
        document.getElementById("create-invite-btn").addEventListener("click", openModal);
        document.getElementById("close-modal-btn").addEventListener("click", closeModal);
        document.getElementById("save-meeting-btn").addEventListener("click", saveMeeting);

        document.getElementById("prev-month").addEventListener("click", () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });

        document.getElementById("next-month").addEventListener("click", () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });

        document.getElementById("today-btn").addEventListener("click", () => {
            currentDate = new Date();
            renderCalendar();
        });

        // Close modal on backdrop click
        document.getElementById("invite-modal").addEventListener("click", (e) => {
            if (e.target.id === "invite-modal") closeModal();
        });

        // Load on page load
        document.addEventListener("DOMContentLoaded", loadEvents);
    </script>
</body>
</html>
